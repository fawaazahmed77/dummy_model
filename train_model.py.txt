import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LogisticRegression
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import classification_report, confusion_matrix, roc_auc_score
import joblib
import warnings
warnings.filterwarnings('ignore')

print("="*50)
print("EARNINGS MANIPULATION MODEL TRAINING")
print("="*50)

# Load data
print("\n1. Loading dataset...")
df = pd.read_excel('Earnings Manipulator (1).xlsx', sheet_name='Data for Model Development')
print(f"   ✓ Loaded {len(df)} records")

# Prepare features
features = ['DSRI', 'GMI', 'AQI', 'SGI', 'DEPI', 'SGAI', 'ACCR', 'LEVI']
X = df[features]
y = df['Manipulator'].map({'Yes': 1, 'No': 0})

print(f"\n2. Features: {', '.join(features)}")
print(f"   ✓ Target variable: Manipulator (1=Yes, 0=No)")

# Check class distribution
print(f"\n3. Class distribution:")
print(f"   - Manipulators: {sum(y==1)} companies")
print(f"   - Non-manipulators: {sum(y==0)} companies")

# Split data
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

print(f"\n4. Train-test split:")
print(f"   - Training: {len(X_train)} samples")
print(f"   - Testing: {len(X_test)} samples")

# Scale features
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

print("\n5. Training model...")
model = LogisticRegression(
    random_state=42,
    class_weight='balanced',
    max_iter=1000,
    solver='liblinear'
)
model.fit(X_train_scaled, y_train)

# Predictions
y_pred = model.predict(X_test_scaled)
y_pred_proba = model.predict_proba(X_test_scaled)[:, 1]

print("\n6. Model Performance:")
print("-" * 30)
print(f"Accuracy: {(y_pred == y_test).mean():.2%}")
print(f"ROC-AUC: {roc_auc_score(y_test, y_pred_proba):.4f}")
print("\nClassification Report:")
print(classification_report(y_test, y_pred))

# Feature importance
print("\n7. Feature Importance:")
feature_importance = pd.DataFrame({
    'Feature': features,
    'Coefficient': model.coef_[0]
})
feature_importance = feature_importance.sort_values('Coefficient', key=abs, ascending=False)
print(feature_importance.to_string(index=False))

# Save model
joblib.dump(model, 'model.pkl')
joblib.dump(scaler, 'scaler.pkl')

print("\n" + "="*50)
print("MODEL SAVED SUCCESSFULLY!")
print("="*50)
print("Files created:")
print("✓ model.pkl (trained model)")
print("✓ scaler.pkl (feature scaler)")
print("\nNow run: streamlit run app.py")